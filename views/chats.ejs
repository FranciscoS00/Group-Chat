<!doctype html>
<html lang="en">
<head>
    <%- include('./partials/head') %>
    <meta charset="UTF-8">
    <title>Aceder chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Icons"
          rel="stylesheet">

    <link href="https://fonts.googleapis.com/css2?family=Material+Icons+Outlined"
          rel="stylesheet">

    <link href="https://fonts.googleapis.com/css2?family=Material+Icons+Round"
          rel="stylesheet">


    <link href="https://fonts.googleapis.com/css2?family=Material+Icons+Sharp"
          rel="stylesheet">


    <link href="https://fonts.googleapis.com/css2?family=Material+Icons+Two+Tone"
          rel="stylesheet">

</head>
<body class="pag">
<div class="page">
    <div class="topbar">
    </div>
    <div class="userbar">
        <div class="left">
            <button><i class="material-icons">menu</i></button>
            <div class="groupname"><span id="chats"></span></div>
            <div class="profpic"><img src="http://www.codeproject.com/KB/GDI-plus/ImageProcessing2/img.jpg"> </div>
            <div class="name"><span id="username"></span></div>
            <button><i class="material-icons">mode</i></button>
        </div>
        <div class="right">
            <form id="logout" method="post" action="/logout"><button value="Log out" type="submit"><i class="material-icons">logout</i></button></form>

        </div>
    </div>

<div class="formcontainer">

<form class="form2" action="/chatroom" method="post" id="form">
    <div class="formlogin">Escolha o chat</div>
    <input type="text" name="username" id="usernameID" hidden>
    <div class="formpart2" id="escolherChat"></div>
    <div class="formpart" id="aceder"></div>
</form>
</div>
<script>
    document.getElementById("form").addEventListener('change', updateValue);

    function updateValue (e) {
        var x = document.getElementById("form");
        x.setAttribute("action","/chatroom?x="+e.target.value);
    }
</script>

<script>
    function AcederChat(chats){
        if(chats.length!==0){
            for(var i=0;i<chats.length;i++){
                var chatPendente = document.createElement("p");
                chatPendente.setAttribute("id",i);
                chatPendente.innerText = chats[i].nome;
                document.getElementById("escolherChat").appendChild(chatPendente);
                var chatPendente = document.createElement("input");
                chatPendente.setAttribute("name","chatsPendentes");
                chatPendente.setAttribute("value",chats[i].nome);
                chatPendente.setAttribute("type","radio");
                document.getElementById(i).appendChild(chatPendente);
            }
            var chatPendente = document.createElement("input");
            chatPendente.setAttribute("name","resposta");
            chatPendente.setAttribute("value","aceder");
            chatPendente.setAttribute("type","submit");
            document.getElementById("aceder").appendChild(chatPendente);
        }
        else{
            var chatPendente = document.createElement("p");
            chatPendente.innerText = "Não está associado a nenhum chat";
            document.getElementById("escolherChat").appendChild(chatPendente);
        }
    }
</script>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const usernameSpan = document.getElementById("username");

    socket.on('connect', () => {

        socket.emit('whoami', (username) => {
            usernameSpan.innerText = username;
            document.getElementById("usernameID").setAttribute("value",username);
        });

        socket.emit('aceder', (chats) => {
            AcederChat(chats);
        });
    });
</script>
</body>
</html>